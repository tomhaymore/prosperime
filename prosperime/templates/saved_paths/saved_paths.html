{% extends "base_full.html" %}

{% block head %}

<script type="text/javascript" src="{{ STATIC_URL }}js/saved_paths.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/drag_and_drop.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/backbone.js"></script>


<!-- 
	This business taken from Django docs, adds CSRF header to Ajax
	 requests automatically. Needed when making POST requests from Backbone
-->
<script type="text/javascript">
// using jQuery
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    crossDomain: false, // obviates need for sameOrigin test
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type)) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

</script>

{% endblock %}





<!-- Content -->
{% block content %}

<!-- Header -->
<div class="content-container main-container">
	<p class="main-header"><span id="path-header"></span></p>
	<p class="main-sub-header">Paths Tags{{profile.headline}}</p>

	<div class="saved-paths-nav-container">&nbsp;</div>

	<div class="saved-paths-container">
		<div class="saved-paths-list pull-left">
		<!-- BACKBONE JUMPS IN HERE -->
		<div id="saved-paths-list"></div>

		</div>


		<div class="saved-paths-right-sidebar pull-right">

			<!-- Right Sidebar -->
			<div id="search-right-sidebar" class="profile-right-sidebar">
				<div class="rounded">
					<p class="sidebar-header">Want to see improvements?</p>
					<p>We'd love to hear from you -- <a href="mailto:feedback@prosperime.com">please drop us a line</a></p>	
					
				</div>

				<div class="rounded">
					<p class="sidebar-header">Your Saved Career Paths</p>
			
					{% if saved_paths %}
						<table class="table table-striped table-condensed table-bordered path-list" id='sidebar-path-list'>
							{% for saved_path in saved_paths %}
								{% if forloop.last %}
									<tr class="saved-path-list-last">
								{% else %}
									<tr>
								{% endif %}
								<td ondragover='allowDrop(event)' ondrop='dropPosition(event, "{{saved_path.title}}", this)'><a href="/saved_paths/#id/?id={{saved_path.id}}">{{saved_path.title}}</a></td>
								</tr>
							{% endfor %}
						</table>
					{% else %}
					<p>You haven't saved any career paths yet. Start one <a href="/saved_paths/create/">here.</a></p>
				{% endif %}
				</div>
			</div>
		</div>
		<div class="clear"></div>
	</div>
</div>
{% endblock %}


{% block templates %}
<script type="text/template" id="saved-path-list-template">

	<!-- /* Headers */ -->
	<!--<div class="main-header pull-left">Career Paths</div>-->
	<!--<div class="search-view pull-right">Search: 
		<ul class="search-view-links inline">
			<li><a href="/search/#companies/">companies</a></li>
			<li><a href="/search/#careers/">careers</a></li> 
		</ul>
	</div>-->
	<div class="clearfix"></div>

	<!-- /* Content Here */ -->
	<div class="path-list"></div>
</script>

<script type="text/template" id="saved-path-single-template">

	<!--<div class="saved-path-title"><%=title%></div>-->
	
	<div class="saved-path-timeline">
		<div id="end">GOAL</div>

		<% 
		<!-- Sort positions by index -->
		positions = _.sortBy(positions, function(pos) {
			return pos.index * -1;
		});

		for (var i = 0; i < positions.length; i++) {

			%>
			<div class="up-arrow" ondragover="highlight(event, this)" ondrop='dropPosition(event, <%=positions[i].index%>, <%=id%>)'>
				<img  draggable="false" src="/static/img/up-arrow.png"/>
			</div>

			<div id="index:<%=positions[i].index%>-id:<%=positions[i].id%>" class="saved-path-position" ondragover="allowDrop(event)" draggable="true" ondragstart="drag(event)">

				<i class="icon-remove-circle hide" title="Remove this position"></i>  

				<%= positions[i].title %> at <%= positions[i].co_name%>
				 || <%=positions[i].index%>  
			</div>
			
			<%
		} %>
	</div>
</script>

<script type="text/template" id="saved-path-thumbnail-single-template">
	
	<div class="thumbnail-title"><%=title%></div>
	<div class="thumbnail-data">
		<% if (positions) {
			%><%=positions.length%><%
		} else {
			%>Currently, no<%
		} %>
		positions, covering career paths such as (career paths), with the end goal of being a (goal)
	</div>
</script>

<script type='text/template' id="saved-path-thumbnail-list-template">
	<div class="saved-path-thumbnail-table">
	<!--
		<div class="saved-path-thumbnail">
			<div class="thumbnail-title">Create a new path</div>
			<div class="thumbnail-data">Click here</div>
		</div>
	-->
	</div>
</script>

<script type="text/template" id="proto-single-template">
	<h1>here</h1>
</script>

<script type="text/template" id="proto-template">
	
	<select id="proto-fill"> </select>


</script>

<!-- Auxilary Functions Go Here -->
<script type="text/javascript">

	
	var highlight = function(ev, elem) {
		ev.preventDefault();
		$(elem).fadeOut(3).fadeIn(3)
		// Do something to indicate that you can rearrange things...
	};


	var dropPosition = function(ev, arrowIndex, path_id) {
		ev.preventDefault();

		// Note: this info is just the id the element dragged.
		// 		It should go by format 'index:#-id:#', i.e.
		//      'index:4-id:44'
		var pos_moved_info = ev.dataTransfer.getData('pos_id').split('-')
		var pos_moved_index = pos_moved_info[0].split(':')[1]
		var pos_moved_id = pos_moved_info[1].split(':')[1]

		if (pos_moved_index == arrowIndex || pos_moved_index - 1 == arrowIndex) {
			// do nothing
		} else {
			var diff = arrowIndex - pos_moved_index;
			if (diff < 0) diff +=1
			changePositionOrder(diff, pos_moved_id, pos_moved_index, path_id)
		}

	};

	// AJAX POST
	var changePositionOrder = function(difference, position_id, pos_index, path_id) {
		$.post('/saved_paths/rearrange/', {difference: difference, pos_id:position_id, pos_index:pos_index, path_id:path_id}, function(response) {
				console.log(response)
				console.log(window.savedPaths.fetch())
				
		});


	};
</script>



{% endblock %}