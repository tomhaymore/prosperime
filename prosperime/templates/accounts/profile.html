{% extends "base_full.html" %}

{% block head %}
<!-- Head -->
<script type="text/javascript" src="{{ STATIC_URL }}js/viz.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/drag_and_drop.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/jquery-ui.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.autocomplete.js"></script>
<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/profile.css" />
<script type="text/javascript" src="{{ STATIC_URL }}js/raphael-min.js"></script>

{% endblock %}



<!-- Content -->
{% block content %}


<!-- Header -->
<div class="main-container content-container">
	<p class="main-header">Profile: <span class="splash-slug">{{profile.first_name}} {{profile.last_name}}</span></p>
	<p class="main-sub-header">{{profile.headline}}</p>
	<span class="pull-left">
		<img class="logo-preview" src="/media/{{profile.default_profile_pic}}" />
	</span>
	<span class="pull-right" id='profile-careers-container'>
		{% if user.profile.all_careers %}
		<ul class="profile-careers-list flat">
			{% for c in user.profile.all_careers %}
				<li class="profile-career"><a class="profile-button" href="/career/{{c.id}}">{{c.long_name}}</a></li>
			{% endfor %}
		</ul>
		{% endif %}
	</span>
	<div class="clear"></div>
	
	<div id="timeline-container">
		<!-- Fill in with JS -->
	</div>
	<div id='timeline-float-screen'>
		<div id='timeline-float-screen-center'></div>
		<div id='timeline-float-screen-left'></div>
		<div id='timeline-float-screen-right'></div>
	</div>

	<div id='position-data-structure' class="hidden-data-structure">

		{% for p in positions %}
			<div class='position-wrapper'>
				{% if p.type == 'education' %}
					<div class='type'>education</div>
				{% elif p.type == 'internship' %}
					<div class='type'>internship</div>
				{% else %}
					<div class='type'>org</div>
				{% endif %}
				<div class='title'>{{p.title}}</div>
				<div class='entity_name'>{{p.co_name}}</div>
				<div class='id'>{{p.id}}</div>
				<div class='description'>{{p.description}}</div>
				<div class='start-date-'>{{p.start_date.month}}/{{p.start_date.year}}</div>
				<div class='end-date'>{{p.end_date.month}}/{{p.end_date.year}}</div>
				<div class='pic'>{{p.pic}}</div>
			</div>
		{% endfor %}
	</div>

	<div id='metadata' class='hidden-data-structure'>
		<div class='start-date'>{{start_date.month}}/{{start_date.year}}</div>
		<div class='end-date'>{{end_date.month}}/{{end_date.year}}</div>
		<div class='total_time'>{{total_time}}</div>
	</div>



			

				<!-- PATH VIZ (you gonna die) -->
				<div class="pull-left span12" style='margin-left:0px'>	
					
						<div class="clear"></div>
						<div>		
			

		

					<!-- Float Screen -->
					<div id="middle-float-screen" class="pull-left span6" ondragover='allowDrop(event)'>
						{% if career_decision_prompt %}
							<div id='career-decision-module'>
								<div id="career-decision-prompt">
								<button class="close" onclick='exitPrompt(false)'>&times;</button>
								<span class='initial-prompt'>
								Would you provide a bit of information on your decision to 
								{% if career_decision_prompt.type == 'education' %}
									attend 
								{% else %}
									work as a {{career_decision_prompt.title}} at 
								{% endif %}
								{{career_decision_prompt.co_name}}? This information will go directly to others who are making the same important career decisions. 
								</span> 
								<div class='btn career-decision-prompt-btn' onclick='revealPrompt()'>Sure</div>
								</div>
								<div id="career-decision-form" class="display-none">
								<button class="close" onclick='exitPrompt(false)'>&times;</button>
								<div class='callout-text'>Thanks you for sharing, this information will be invaluable to others just like you.</div>
								<br/>
								<form class='form'>
									<input type='text' class='full-width' placeholder='Where else did you considering working?' name='alternates' id='alternatesTextBox'/><br/>
									{% if career_decision_prompt.type == 'education' %}
									<textarea rows='2' class="full-width" name='reason' placeholder='Why did you decide to attend {{career_decision_prompt.co_name}}'></textarea>
									{% else %}
									<textarea rows='2' class='full-width' name='reason' placeholder='Why did you decide to work at {{career_decision_prompt.co_name}}?'></textarea>
									{% endif %}
									<label>On a scale from 1-5, please rate the following elements of your experience at {{career_decision_prompt.co_name}}.</label>
								<div id="mentorshipCheckboxes">
									<div id='control-headers'>
										<span id='worst'>Poor</span>
										<span id='best'>Excellent</span>
									</div>
									<div id='radio-set-mentorship'>
									<span class='input-label'>Mentorship:</span>
									<label class="radio inline">
  										<input type="radio" id="mentorshipNA" name='mentorship-radio' value="0"> n/a
									</label>
									<label class="radio inline">
  										<input type="radio" id="mentorship1" name='mentorship-radio' value="1"> 1
									</label>
									<label class="radio inline">
  										<input type="radio" id="mentorship2" name='mentorship-radio' value="2"> 2
									</label>
									<label class="radio inline">
  										<input type="radio" id="mentorship3" name='mentorship-radio' value="3"> 3
									</label>
									<label class="radio inline">
  										<input type="radio" id="mentorship4" name='mentorship-radio' value="4"> 4
									</label>
									<label class="radio inline">
  										<input type="radio" id="mentorship5" name='mentorship-radio' value="5"> 5
									</label>
									
									</div>

									<div id='radio-set-skills'>
									<span class='input-label'>Skills Gained:</span>
									<label class="radio inline">
  										<input type="radio" name='skills-radio' id="skillsNA" value="0"> n/a
									</label>
									<label class="radio inline">
  										<input type="radio" name='skills-radio' id="skills1" value="1"> 1
									</label>
									<label class="radio inline">
  										<input type="radio" name='skills-radio' id="skills2" value="2"> 2
									</label>
									<label class="radio inline">
  										<input type="radio" name='skills-radio' id="skills3" value="3"> 3
									</label>
									<label class="radio inline">
  										<input type="radio" name='skills-radio' id="skills4" value="4"> 4
									</label>
									<label class="radio inline">
  										<input type="radio" name='skills-radio' id="skills5" value="5"> 5
									</label>
									</div>

									<div id='radio-set-social'>
									<span class='input-label'>
									Social/Environment:</span>
									<label class="radio inline">
  										<input type="radio" name='social-radio' id="socialNA" value="0"> n/a
									</label>
									<label class="radio inline">
  										<input type="radio" name='social-radio' id="social1" value="1"> 1
									</label>
									<label class="radio inline">
  										<input type="radio" name='social-radio' id="social2" value="2"> 2
									</label>
									<label class="radio inline">
  										<input type="radio" name='social-radio' id="social3" value="3"> 3
									</label>
									<label class="radio inline">
  										<input type="radio" name='social-radio' id="social4" value="4"> 4
									</label>
									<label class="radio inline">
  										<input type="radio" name='social-radio' id="social5" value="5"> 5
									</label>
									</div>

									<div id='radio-set-overall'>	
									<span class='input-label'>Overall:</span>
									<label class="radio inline">
  										<input type="radio" name='overall-radio' id="overallNA" value="0"> n/a
									</label>
									<label class="radio inline">
  										<input type="radio" name='overall-radio' id="overall1" value="1"> 1
									</label>
									<label class="radio inline">
  										<input type="radio" name='overall-radio' id="overall2" value="2"> 2
									</label>
									<label class="radio inline">
  										<input type="radio" name='overall-radio' id="overall3" value="3"> 3
									</label>
									<label class="radio inline">
  										<input type="radio" name='overall-radio' id="overall4" value="4"> 4
									</label>
									<label class="radio inline">
  										<input type="radio" name='overall-radio' id="overall5" value="5"> 5
									</label>
									</div>
								</div>
								<br/>
								{% if career_decision_prompt.type == 'education' %}
								<textarea rows='2' class='full-width' name='comments' placeholder='Any additional comments for people considering attending {{career_decision_prompt.co_name}}?'</textarea>
								{% else %}
								<textarea rows='2' class='full-width' name='comments' placeholder='Any additional comments for people considering working at {{career_decision_prompt.co_name}}?'></textarea>
								{% endif %}
								<br/>
								<div>Select how you want this information to be displayed:</div>
								<div id='privacy-radio'>
								<label class="radio inline">
  									<input type="radio" name='privacy-radio' value="anonymous"/ > Anonymous
								</label>
								<label class='radio inline'>
									<input type='radio' name='privacy-radio' value='public' />Public
								</label>
								</div>
								<br/>
								<div class='btn submitBtn' onclick='submitCareerDecision({{career_decision_prompt.id}})'>Done</div>

								</form>
								</div>
							</div>
						{% else %}
						<a>For more information, hover over a position</a>
						{% endif %}
					</div>	

			<!-- Right Sidebar -->
			<div id="profile-right" class="span3 pull-right">
			<!-- 	<div class="rounded">
					{% if user %}
						<p class="sidebar-header">Want to see improvements?</p>
						<p>We'd love to hear from you -- <a href="mailto:feedback@prosperime.com">please drop us a line</a></p>
					{% endif %}
				</div> -->

				<!-- Profile Saved Paths -->
				<!-- <div class="rounded">
					<p class="sidebar-header">{{profile.first_name}}'s Saved Career Paths</p>

					{% if saved_paths %}
						<table class="table table-striped table-condensed table-bordered position-list">		
						{% for path in saved_paths %}
							<tr>
								<td><a href="/saved_paths/#title/?t={{path.title}}"> {{path.title}} </a></td>
							</tr>
						{%endfor%}
						</table>
					{% else %}
						<p>{{profile.first_name}} hasn't saved any career paths yet.</p>
					{% endif %}
				</div> -->

				<!-- Viewer Saved Paths -->
				<div class="rounded">
					<p class="sidebar-header">Your Saved Career Paths</p>
					<p> Like what {{profile.first_name}} has done? Drag any of the positions shown into your desired career path or <a onclick='createNewPath()'>create a new one.</a></p>
						<table class="table table-striped table-condensed table-bordered path-list" id='sidebar-path-list'>			
							<tr><td class="timeline-description-header">
								<a href="/saved_paths/">View All</a>
							</td></tr>
						{% for saved_path in viewer_saved_paths %}
							{% if forloop.last %}
								<tr class="saved-path-list-last">
							{% else %}
								<tr>
							{% endif %}
								<td ondragover='allowDrop(event)' ondrop='dropPosition(event, "{{saved_path.title|escape}}", this)'><a href="/saved_paths/#id/?id={{saved_path.id}}">{{saved_path.title}}</a></td>
								</tr>
						{% endfor %}
						</table>	
				</div>
			</div>
			<div class="clear"></div>
		</div>

			




<!-- 	<defs>
		<linearGradient id="line-left" x1="0%" y1="0%" x2="100%" y2="0%">
		<stop offset="0%" style="stop-color:rgb(255,255,0); stop-opacity:1"/>
		<stop offset="100%" style="stop-color:rgb(255,0,0); stop-opacity:1"/>
		</linearGradient>
	</defs> -->
		
<script type="text/javascript">
	(function() {
		/*  Following code taken from http://stackoverflow.com/questions/4771517/raphael-js-path-line-with-gradient to add linear gradients to paths (no native suppport from Raphael) */
		if (Raphael.vml) {
        	Raphael.el.strokeLinearGradient = function() {
            	// not supporting VML yet
            	return this; // maintain chainability
        	};
   		} else {
        	var setAttr = function(el, attr) {
            	var key;
            	if (attr) {
                	for (key in attr) {
                   		if (attr.hasOwnProperty(key)) 
                        	el.setAttribute(key, attr[key]);
                	}
            	} else 
                	return document.createElementNS("http://www.w3.org/2000/svg", el);
      
            	return null;
        	};

	        var defLinearGrad = function(defId, stops) {
	            var def = setAttr("linearGradient");
	            var i, l;
	            def.id = defId;

	            for (i = 0, l = stops.length; i < l; i += 1) {
	                var stopEle = setAttr("stop");
	                var stop = stops[i];
	                setAttr(stopEle, stop);

	                def.appendChild(stopEle);
	            }

	            return def;
	        };

	        Raphael.el.strokeLinearGradient = function(defId, width, stops) {
	        	console.log(this)
	            if (stops) {
	                this.paper.defs.appendChild(defLinearGrad(defId, stops));
	            }
	            setAttr(this.node, {
	                "stroke": "url(#" + defId + ")",
	                "stroke-width": width,
	                "fill": "url(#" + defId + ")"
	            });
	            return this; // maintain chainability
	        };

	        Raphael.st.strokeLinearGradient = function(defId, width, stops) {
	            return this.forEach(function(el) {
	                el.strokeLinearGradient(defId, width, stops);
	            });
	        };

	        Raphael.fn.defineLinearGradient = function(defId, stops) {
	            this.defs.appendChild(defLinearGrad(defId, stops));
	            console.log(this.defs)
	        };
	    }
	}());
	/********/
	/* MAIN */
	/********/
	$(function() {


		//var random_number = Math.floor(Math.random()*3)
		// if (random_number > 1) horizontal_timeline()
		// else vertical_timeline()
		var positions = $('#position-data-structure')
		if (positions.children().length > 0)
			horizontal_timeline()
		//vertical_timeline()
	});

	var vertical_timeline = function() {
		/*********************/
		/* VERTICAL TIMELINE */
		/*********************/

		// Get Metadata
		var positions = $('#position-data-structure')
		var num_positions = positions.children().length
		if (num_positions == 0) return false;
	
		console.log('num positions: ' + num_positions)
		console.log('equal offset: ' + equal_offset)

		var metadata = $('#metadata')
		var total_start_date = metadata.children()[0].innerHTML
		var total_end_date = metadata.children()[1].innerHTML
		var total_time = metadata.children()[2].innerHTML

		/* CONSTANTS */

		// Info Box
		var info_box_buffer = 15
		var info_box_width = 300
		var info_box_height = 100
		// var equal_offset = (vertical_timeline_length / (num_positions + 1))
		var equal_offset = info_box_height + (2 * info_box_buffer)

		// Pic
		// var pic_width = Math.ceil(info_box_width / 4)
		// var pic_height = (equal_offset - info_box_buffer - 5) * .75
		var pic_width = 75
		var pic_height = 50
		
		// Description Box
		var description_box_width = 400
		var description_box_height = 400

		// Timeline
		var vertical_timeline_start_offset = 75
		var vertical_timeline_length = num_positions * equal_offset + vertical_timeline_start_offset
		console.log('timeline length = ' + vertical_timeline_length)

		/* Create SVG Elements */
		// Create Paper
		var paper_width = 1000
		var paper_height = vertical_timeline_length + 200
		var paper = new Raphael('timeline-container', paper_width, paper_height)

		
		// Timeline
		var main_timeline = paper.path('M100,'+vertical_timeline_start_offset+' L100,'+(vertical_timeline_start_offset + vertical_timeline_length)).attr({
			'stroke':'#555',
			'stroke-dasharray':'2, 2'
		})

		
		// End Date Rectangle
		var top_rect = paper.rect(50, vertical_timeline_start_offset - 30, 100, 30, 2).attr({
			'stroke':'#c0c0c0',
			'stroke-width':'1',
			'fill':'rgb(41,98,152)',
			// 'fill-opacity':0.7,
		})

		// End Date Rectangle Text
		var top_rect_text = paper.text(100, vertical_timeline_start_offset - 15, 'Present')
		top_rect_text.attr({
			'font-size':'14pt',
			'stroke':'#fffffe',
			'font-weight':'200',
			'font-family': '"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif',
		})
		top_rect_text.node.setAttribute('class','loose-spacing')

		// Start Date Rectangle
		var bottom_rect = paper.rect(50, vertical_timeline_start_offset + vertical_timeline_length, 100, 30, 2)
		bottom_rect.attr({
			'stroke':'#c0c0c0',
			'fill':'rgb(41,98,152)',
			// 'fill-opacity':0.7,
		})

		// Start Date Rectangle Text
		var bottom_rect_text = paper.text(100, vertical_timeline_start_offset + vertical_timeline_length + 15, total_start_date)
		bottom_rect_text.attr({
			'font-size':'14px',
			'stroke':'#fffffe',
			'font-weight':'200',
			'font-family': '"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif',
		})
		bottom_rect_text.node.setAttribute('class','loose-spacing')


		var previous_end = vertical_timeline_start_offset
		// Add position dots
		for (var i = num_positions; i > 0; i--) {

			// Get Position data
			var wrapper = positions.children()[i - 1]
			var type = wrapper.childNodes[1].innerHTML
			var title = wrapper.childNodes[3].innerHTML
			var entity_name = wrapper.childNodes[5].innerHTML
			var id = wrapper.childNodes[7].innerHTML
			var description = wrapper.childNodes[9].innerHTML
			var start_date = wrapper.childNodes[11].innerHTML
			var end_date = wrapper.childNodes[13].innerHTML
			var pic = wrapper.childNodes[15].innerHTML
			console.log(pic)

			var color = 'rgb(50,121,202)'
			if (type == 'education') color = 'rgb(191,51,48)'
			if (type == 'internship') color = 'rgb(255,195,64)'


			// Outer Dot
			var y = 50 + (equal_offset * i)
			var outer_dot = paper.circle(100, y, 12)
			outer_dot.attr({
				'stroke-width':'1',
				'stroke':'rgb(50,121,202)',
				'fill':'none',
			});

			// Inner Dot
			var dot = paper.circle(100, y, 7)
			dot.attr({
				'stroke-width':1,
				'stroke':'rgb(50,121,202)',
				'fill':'rgb(50,121,202)',
				'fill-opacity':'.4',
			})

			if (type == 'education') {
				outer_dot.attr({'stroke':'rgb(191,51,48)'})
				dot.attr({'stroke':'rgb(191,51,48)', 'fill':'rgb(191,51,48)'})
			} else if (type == 'internship') {
				outer_dot.attr({'stroke':'rgb(255,195,64)'})
				dot.attr({'stroke':'rgb(255,195,64)', 'fill':'rgb(255,195,64)'})
			} else type = 'position' //'org' not good for display

			// // Timeline chunk
			// if (i == num_positions) {
			// 	var top = previous_end
			// 	var bottom = previous_end + equal_offset - 50
			// 	console.log('s: ' + top + ' e: '+ bottom)
			// }

			// var path = paper.path('M100,' + top + ' L100,' + bottom).attr({'stroke':'#555'})
			// 	previous_end = top + 32


			var box_offset = (equal_offset - info_box_buffer) / 2
			var info_box = paper.path('M112,' + y + ' L117,' + (y-5) + 'L117,' + (y - box_offset) + ' L' + (117 + info_box_width) + ', ' + (y - box_offset) + ' L' + (117 + info_box_width) + ', ' + (y + box_offset) + ' L117,' + (y + box_offset) + ' L117,' + (y+5) + ' L112,' + y)
			


			var info_box_header_line = paper.path('M117,' + (y - box_offset + 20) + ' L' + (117 + info_box_width) + ',' + (y - box_offset + 20))

			// // If profile pic, throw it in there
			// if (pic.indexOf('none') == -1) {
			
			// 	var image = paper.image('../media/'+pic, 120, y - box_offset + 25, pic_width, pic_height)
				
			// }

			var info_box_dates = paper.text(155,(y - box_offset + 10), format_date(start_date) + '/' + format_date(end_date)).attr({
					'font-family':'"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif',
					'font-size':'12px',
				})

			var info_box_type = paper.circle(119 + (info_box_width) - 20, (y - box_offset + 10), 4).attr({
					'stroke':color,
					'fill':color
			})


			var info_box_title = paper.text(117 + (info_box_width / 2), y - 10, title)
			info_box_title.node.setAttribute('class','info_box_text')
			info_box_title.attr({
				'font-family': '"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif',
				'font-size':'14px',
				'font-weight':'500'
			})

			var info_box_entity_name = paper.text(117 + (info_box_width / 2), y + 20, entity_name)
			info_box_entity_name.node.setAttribute('class','info_box_text')
			info_box_entity_name.attr({
				'font-family': '"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif',
				'font-size':'14px',
				'font-weight':'500'
			})

			if (info_box_title.getBBox().width > info_box_width || info_box_entity_name.getBBox().width > info_box_width) {
				console.log('that shit is too long')
			}

			dot.data('description', description)
			dot.data('color', color)
			dot.data('y', y)
			type = type.charAt(0).toUpperCase() + type.slice(1);
			dot.data('type', type)
			dot.data('title', title)
			dot.data('entity_name', entity_name)


			// On hover to dots
			dot.hover(function() {
				// Remove old boxes
				if ($('#description_box').length > 0) {
					$('#description_box').remove()
					$('#description_box_header').remove()
					$('#description_box_header_line').remove()
					$('#description_box_header_info').remove()
				}

				// Add new box
				var start_x = 117 + info_box_width
				var description_box = paper.path(
					'M' + start_x + ', ' + this.data('y') + 
					' L' + (start_x + 15) + ',' + (this.data('y') - 15) +
					' L' + (start_x + 15) + ',' + (this.data('y') - 15 - (description_box_height / 3)) +
					' L' + (start_x + 15 + description_box_width) + ', ' + (this.data('y') - 15 - (description_box_height / 3)) + 
					' L' + (start_x + 15 + description_box_width) + ', ' + (this.data('y') - 15 + description_box_height / 3) + 
					' L' + (start_x + 15) + ', ' + (this.data('y') - 15 + description_box_height / 3) + 
					' L' + (start_x + 15) + ', ' + (this.data('y') + 15) + 
					' L' + start_x + ', ' + this.data('y')
					).attr({
						'stroke-linejoin':'miter',
					})


				// Add header line
				var description_box_header_line = paper.path(
					'M' + (start_x + 15) + ', ' + (this.data('y') - 15 - (description_box_height / 3) + 30) + ' L' + (start_x + 15 + description_box_width) + ', ' + (this.data('y') - 15 - (description_box_height / 3) + 30))

				// Add header info
				var description_box_header = paper.text((start_x + 55), (this.data('y') - (description_box_height / 3) + 3), this.data('type')).attr({
						'font-size':'14pt',
						'font-family': '"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif',
						'stroke':this.data('color')
				})
				description_box_header.node.setAttribute('class','loose-spacing')

				var description_box_header_info = paper.text((start_x + 100), (this.data('y') - (description_box_height / 3) + 3), (this.data('title') + ' at ' + this.data('entity_name'))).attr({
						'font-size':'14pt',
						'font-family': '"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif',
						'text-anchor':'start'
					})			

				// // Add content to the box
				// var description_box_header = paper.text((start_x + ((15 + description_box_width) / 2)), (this.data('y') - (description_box_height / 3) + 30), 'A description of said position').attr({
				// 	'font-size':'12pt',
				// 	'font-family': '"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif',
				// })
				// description_box_header.node.id = 'description_box_header'

				// Set ID's so they can be erased
				description_box.node.id = 'description_box'
				description_box_header_line.node.id = 'description_box_header_line'
				description_box_header.node.id = 'description_box_header'
				description_box_header_info.node.id = 'description_box_header_info'

			},
			function() {

			});
	
 		}
	}


	var horizontal_timeline = function() {
		/***********************/
		/* HORIZONTAL TIMELINE */
		/***********************/

		/** NOTE **/
		// The way this is designed, data is passed from the view into
		// the dom and stored in a hidden div structure. Data is then 
		// pulled from there and used here. In the JS code, data is 
		// stored on the inner 'dot' svg element

		// Constants
		var lvl1_offset = 30
		var lvl2_offset = 50

		var education_color = '#bf3330'
		var internship_color = '#ffc340'
		var position_color = 'rgb(50,121,202)'

		var paper_width = 1000
		var paper_height = 165

		var outer_dot_radius = 12
		var inner_dot_radius = 2


		// Create paper and timeline structure
		var paper = new Raphael('timeline-container', paper_width, paper_height)
		

		// var timeline = paper.path("M100,100  L875,100")
		// timeline.attr({
		// 	stroke:'#555',
		// 	"stroke-width":2,
		// 	'stroke-linecap':'round',
		// });

		// paper.defineLinearGradient("grad1", [{
		//     "id": "s1",
		//     "offset": "0",
		//     "style": "stop-color:#555;stop-opacity:1;"
		// },
		// {
		//     "id": "s2",
		//     "offset": "1",
		//     "style": "stop-color:#fffffe;stop-opacity:1;"
		// }]);

		var positions = $('#position-data-structure')
		var num_positions = positions.children().length
		var equal_offset = (775 / (num_positions + 1))

		var metadata = $('#metadata')
		var total_start_date = metadata.children()[0].innerHTML
		var total_end_date = metadata.children()[1].innerHTML
		var total_time = metadata.children()[2].innerHTML
		var offset = Math.floor(775/total_time)

		// // Convenience Print-outs
		// console.log('start date: ' + total_start_date)
		// console.log('offset in pixels: ' + offset)
		console.log('num position: ' + num_positions)
		// console.log('###########################')

		// Beginning and End Text Display Dates for Timeline
		var start_date_text = paper.text(70,100, total_start_date)
		start_date_text.attr({'font-size':'12px', 'stroke':'#c0c0c0', 'text-anchor':'end'})

		var end_date_text = paper.text(900,100, 'Current')
		end_date_text.attr({'font-size':'12px', 'stroke':'#c0c0c0', 'text-anchor':'start'})

		/* MAIN LOOP */
		var previous_offsets = {} // so we can avoid overlapping
		var previous_width = 0;
		var previous_text_offset = 70
		var previous_end = 84

		var rand = Math.floor(Math.random()*1)
		for (var i = 0; i < num_positions; i++) {
			var overlap = false
			var wrapper = positions.children()[i]
			var type = wrapper.childNodes[1].innerHTML
			var title = wrapper.childNodes[3].innerHTML
			var entity_name = wrapper.childNodes[5].innerHTML
			var id = wrapper.childNodes[7].innerHTML
			var description = wrapper.childNodes[9].innerHTML
			var start_date = wrapper.childNodes[11].innerHTML
			var end_date = wrapper.childNodes[13].innerHTML

			var start_offset = offset * (months_difference(total_start_date.split('/')[0], total_start_date.split('/')[1], start_date.split('/')[0], start_date.split('/')[1], false, 'upper'))

			// Still need to check if they put in a future date
			if (end_date == 'Current' || end_date.length <= 1) {
				var end_offset = 875
			} else {
				var end_offset = start_offset + (offset * (months_difference(start_date.split('/')[0], start_date.split('/')[1], end_date.split('/')[0], end_date.split('/')[1], false, 'upper'))) + 100
			}

			// Move dots that collide
			if (start_offset in previous_offsets) {
				console.log('duplicate, moving dot')
				overlap = true
				start_offset += outer_dot_radius // calculate this so they don't mash
				// This is could still clash if original+12 in set
			}

			previous_offsets[start_offset] = true
			console.log('title: ' + title + ' start offset: ' + start_offset + ' end offset: ' + end_offset)
			// console.log(title + " " + start_date + ' ' + end_date)
			

			// Set dot color based on type
			var color
			if (type == 'education') color  = education_color
			else if (type == 'internship') color = internship_color
			else {
				type = 'position' // not 'org'
				color = position_color
			}

			// Outer Dot
			var outer_dot = paper.circle(100 + start_offset, 100, outer_dot_radius)
			outer_dot.attr({
				'stroke-width':'1',
				'stroke':color,
				'fill':color,
				'fill-opacity':'0',
			});

			// Inner Dot
			var dot = paper.circle(100 + start_offset, 100, inner_dot_radius)
			dot.attr({
				'stroke-width':1,
				'stroke':color,
				'fill':color,
				// 'fill-opacity':'1', //.6
			})

		
			// Text Blurb w/ Entity Name
			if (i % 4 == 0) var level = 1
			else if (i % 4 == 1) var level = 4
			else if (i % 4 == 2) var level = 3
			else var level = 2

			var position_title
			var width
			var y_start
			var y_1
			var y_2
			var base = 100
			var line_height = 20
			switch(level) {
				case 1:
					// console.log('1: ' + entity_name)
					position_title = paper.text(100 + start_offset, 100 - lvl1_offset, entity_name)
					width = position_title.getBBox().width
					y_start = base - outer_dot_radius // 88
					y_1 = base - line_height // 80
					y_2 = base - (2 * line_height) // 60

					break;

				case 2:
					// console.log('2: ' + entity_name)
					position_title = paper.text(100 + start_offset, 100 + lvl2_offset, entity_name)
					width = position_title.getBBox().width
					y_start = base + line_height + outer_dot_radius // 132
					y_1 = base + (2 * line_height) // 140
					y_2 = base + (3 * line_height) // 160

					break;

				case 3:
					// console.log('3: ' + entity_name)
					position_title = paper.text(100 + start_offset, 100 + lvl1_offset, entity_name)
					width = position_title.getBBox().width
					y_start = base + outer_dot_radius
					y_1 = base + line_height
					y_2 = base + (2 * line_height)

					break;

				case 4:
					// console.log('4: ' + entity_name)
					position_title = paper.text(100 + start_offset, 100 - lvl2_offset, entity_name)
					width = position_title.getBBox().width
					y_start = base - line_height - outer_dot_radius
					y_1 = base - (2 * line_height)
					y_2 = base - (3 * line_height)
	
					break;
			}
			var position_title_container = paper.path(
						'M' + (100 + start_offset) + ', ' + y_start + ' ' + 
						'L' + (100 + start_offset + 5) + ', ' + y_1 + ' ' +
						'L' + (100 + start_offset + (width / 2) + 5) + ', ' + y_1 + ' ' +  
						'L' + (100 + start_offset + (width / 2) + 5) + ', ' + y_2 + ' ' + 
						'L' + (100 + start_offset - (width / 2) - 5) + ', ' + y_2 + ' ' + 
						'L' + (100 + start_offset - (width / 2) - 5) + ', ' + y_1 + ' ' +  
						'L' + (100 + start_offset - 5) + ', ' + y_1 + ' ' +  
						'L' + (100 + start_offset) + ', ' + y_start
						)


			position_title.attr({
				'font-variant':'small-caps',
				'font-family': '"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif',
			})

			// Set Data
			position_title.data('dot_id', dot.id)
			outer_dot.data('dot_id', dot.id)

			if (title) dot.data('title',title)
			else dot.data('title', 'None')
			dot.data('entity_name', entity_name)
			dot.data('id', id)
			dot.data('description', description)
			dot.data('start_date', format_date(start_date))
			dot.data('end_date', format_date(end_date))
			dot.data('start_offset', start_offset + 100)
			dot.data('end_offset', end_offset)
			dot.data('color', color)
			dot.data('type', type)


			// Add timeline chunk
			if (start_offset > 12 && start_offset < (775 - 12) && !overlap && (previous_end + 16 < start_offset + 100)) {
				var start_line = previous_end + 32
				var end_line = start_offset - 16 + 100
				console.log('line: ' + start_line + ' : ' + end_line)
				var path_size = "M" + start_line + ",100 L" + end_line + ",100" 
				var path = paper.path(path_size)
				path.attr({
					stroke:'#c0c0c0',
					"stroke-width":1,
					'stroke-linecap':'round',
					'opacity':'0.8',
					'stroke-dasharray':'2'
				});
				previous_end = end_line
			}

		
			/* HOVERS */
			// Outer Dot
			outer_dot.hover(function() {
				var dot = paper.getById(this.data('dot_id'))
				horizontal_hover_in(dot, paper)
			}, function() {
				var dot = paper.getById(this.data('dot_id'))
				horizontal_hover_out(dot, paper)
			})

			// Inner Dot
			dot.hover(function() {
				horizontal_hover_in(this, paper)
			}, function() {
				horizontal_hover_out(this, paper)
			});

			// Title Blurb
			position_title.hover(function() {
				var dot = paper.getById(this.data('dot_id'))
				horizontal_hover_in(dot, paper)
			},
			function() {
				var dot = paper.getById(this.data('dot_id'))
				horizontal_hover_out(dot, paper)
			});
		}
		//Fencepost
		var start_line = previous_end + 32 
		var path_size = "M" + start_line + ",100 L875,100" 
		var path = paper.path(path_size)
		path.attr({
			stroke:'#c0c0c0',
			"stroke-width":1,
			'stroke-linecap':'round',
			'opacity':'0.8'
		});
	}
	// Hover utility
	var horizontal_hover_in = function(dot, paper) {
			var data = dot.data

			/* Remove old elements */
			if ($('#duration_rect').length > 0) $('#duration_rect').remove()
			$('#timeline-float-screen-center').removeClass().empty()
			$('#timeline-float-screen-left').removeClass().empty()
			$('#timeline-float-screen-right').removeClass().empty()

			/* Duration Rectangle */
			var x = parseInt(dot.data('end_offset')) - parseInt(dot.data('start_offset'))
			var duration_rect = paper.rect(dot.data('start_offset') + 12, 95, x, 10, 2)
			duration_rect.attr({
				'stroke': dot.data('color'),
				'stroke-linecap':'butt',
				'fill': dot.data('color'),
				'fill-opacity': .6
			})
			duration_rect.node.id = 'duration_rect'

			var headerString = '<span class="timeline-start-date">' + 
				dot.data('start_date') + '</span>' + '-' + 
				'<span class="timeline-end-date">' +
				dot.data('end_date') + '</span>' +
				'<span class="timeline-entity-name">' +
				dot.data('entity_name') + '</span>'
				
			if (dot.data('title') != 'None') 
				headerString += '<span class="timeline-title">' +
				dot.data('title') + '</span><br/>'

			// A). Title & Description
			if (dot.data('description') != 'None') {

				descriptionString = '<span class="timeline-description">' + dot.data('description') + '</span>'
				$('#timeline-float-screen-left').html(headerString)
				$('#timeline-float-screen-right').html(descriptionString)
	
				$('#timeline-float-screen-left').addClass('background-' + dot.data('type'))
				$('#timeline-float-screen-right').addClass('background-'+ dot.data('type'))

			// B). Title only
			} else {
				$('#timeline-float-screen-center').html(headerString)
				$('#timeline-float-screen-center').addClass('background-' + dot.data('type'))
			}	
			
			// // Finally, darken inner dot
			// dot.attr({
			// 	'r':'5'
			// })
		}
		
	var horizontal_hover_out = function(dot, paper) {
	
		// dot.attr({
		// 	'r':'2'
		// })

	}

	/* Page-specific drag for GA */
	function dragPos(ev) {
  		ev.dataTransfer.setData("pos_id", ev.target.id);
    	_gaq.push(['_trackEvent', 'profile', 'positionDragged'])
  	};


	/* Need JQuery for the AJAX request, so put it here */
	var dropPosition = function(ev, path_title, elem) {
		_gaq.push(['_trackEvent', 'profile', 'positionDropped'])
		ev.preventDefault();
		var pos_id = ev.dataTransfer.getData("pos_id");

		$.post('/saved_paths/save/', {title: path_title, pos_id: pos_id, csrfmiddlewaretoken: '{{csrf_token}}'}, function(response) {
				console.log(response)
				if (response['success']) {
					highlight(elem)
				}
		}, 'json');
	};

	/* Inelegant but effective way to pulsate the element w/o
	   external JQuery libraries */
	var highlight = function(elem) {
		$(elem).fadeIn(100).fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100);
	};

	var newPathAjax = function() {
		_gaq.push(['_trackEvent', 'profile', 'newPathCreated'])

		var title = $('#new-path-box').val()
		if (title.length < 1) {
			errorCreatingPath('title')
			return
		}

		// Attempt POST request via AJAX to create path
		$.post('/saved_paths/create/', {title: title, csrfmiddlewaretoken: '{{csrf_token}}'}, function(response) {
				if (response['success']) {
					console.log(response)
					// Construct new table element for path
					var newRow = "<tr><td ondragover='allowDrop(event)' ondrop='dropPosition(event," + title + ", this)'><a href='/saved_paths/#id/?id=" + response['id'] + "'>" + title + "</a></td></tr>"

					// Add to DOM
					$('#sidebar-path-list > tbody:last').append(newRow)
					
					// Clear text field
					$('#new-path-box-row').remove()
				} else {
					errorCreatingPath('db')
				}
		}, 'json');
	};

	var errorCreatingPath = function(reason) {
		_gaq.push(['_trackEvent', 'profile', 'errorCreatingPath'])
	
		var createBox = $('#new-path-box')
		if (reason == "db") {
			console.log("Error in the view creating new path...")
			createBox.val("Please enter a title")
		} else if (reason == "title") {
			createBox.val("Please enter a title")
		}

		highlight(createBox)
	};

	/* Used in profile pages. Onmouseover event renders the description
	   for a given element in the element id='middle-float-screen' */
	var showDescription = function(index, title, co_name, start_date, end_date) {
		// Don't override the prompt!
		if ($('#career-decision-module').length > 0) {
			console.log('got in here')
			return false;
		}

		// Empty what's in the float screen
		$('#middle-float-screen').empty()
		// If no description, will throw exception
		try {
			// Couldn't get this to work in JQ so stopped trying
			var description = document.getElementsByClassName('timeline-description-text')[index].innerHTML
			var newText = "<div class='box-header'>"
			if (title) newText += title
			if (co_name) newText += ' at ' + co_name
			newText += "</div>"
			if (start_date) {
				newText += "<div class='box-dates'>"
				newText += start_date.replace('1, ','')
				newText += ' - '
				if (end_date == "Current") newText += "Current"
				else newText += end_date.replace('1, ', '')
				newText += "</div>"
			}

			if (description) newText += "<div class='box-description'>" + description + "</div>"
		} catch (err) {
			var newText = '<a>For more information, hover over a position</a>'
		}
		$('#middle-float-screen').html(newText);
	};


	var revealPrompt = function() {
		$('#career-decision-prompt').hide()
		$('#career-decision-form').toggleClass('display-none')
		$('#profile-left').css('opacity','.4')
		$('#profile-right').css('opacity','.4')
		$('#timeline').css('opacity', '.4')
	}

	var exitPrompt = function(success) {

		$('#middle-float-screen').empty()	
		$('#profile-left').css('opacity','1')
		$('#profile-right').css('opacity','1')
		$('#timeline').css('opacity', '1')

		// If successful, show user something that indicates so
		if (success) {
			$('#middle-float-screen').append('<a>Thanks! ')
		} else {
			$('#middle-float-screen').append('<a>For more information, hover over a position</a>')
		}

		
	}

	var submitCareerDecision = function(pos_id) { 

		var alternates = $('input[name="alternates"]', '#career-decision-form').val()
		if (alternates === undefined) alternates = null
		var reason = $('textarea[name="reason"]', '#career-decision-form').val()
		if (reason === undefined) reason = null
		var mentorship = $('input[name="mentorship-radio"]:checked').val()	
		if (mentorship === undefined) mentorship = 0
		var skills = $('input[name="skills-radio"]:checked').val()
		if (skills === undefined) skills = 0
		var social = $('input[name="social-radio"]:checked').val()
		if (social === undefined) social = 0
		var overall = $('input[name="overall-radio"]:checked').val()
		if (overall === undefined) overall = 0


		var comments = $('textarea[name="comments"]','#career-decision-form').val()
		if (comments === undefined) comments=null
		var privacy = $('input[name="privacy-radio"]:checked').val()

		$.post('/careers/addDecision/', {pos_id: pos_id, alternates: alternates, reason: reason, mentorship: mentorship, skills: skills, social:social, overall: overall, comments: comments, privacy: privacy, csrfmiddlewaretoken: '{{csrf_token}}'}, function(response) {
				console.log(response)
		}, 'json');

		exitPrompt(true);
	}



	/* Adds autocomplete to 'Alternates' textbox */
	$('#alternatesTextBox').autocomplete({
    	serviceUrl: '/careers/entityAutocomplete/',
    	delimiter: ', ',
    });

	/* Prevents submitting the form when 'Enter' is pressed */
    $('#career-decision-form').bind("keyup", function(e) {
  		var code = e.keyCode || e.which; 
  		if (code  == 13) {     
    		e.preventDefault();
    		return false;
  		}
	});


	var upper_timeline_limit = 200;
	var months_difference = function(mo1, yr1, mo2, yr2, compress, round) {

		var diff = 12 * (yr2 - yr1);
		diff += (mo2 - mo1);

		if(compress) {
			diff = diff / 2
			if (round == "upper") diff = Math.ceil(diff)
			if (round == "lower") diff = Math.floor(diff)
		}
		return diff;
	};

	/* Takes a date of format MM/YYYY and returns MM.YY */
	var format_date = function(date) {
		if (date.length == 1) return 'Current'
		var split_date = date.split('/')
		return split_date[0] + '.' + split_date[1].substring(2)
		// if (split_date[0].length == 1) 
		// 	return '0' + split_date[0] + '.' + split_date[1].substring(2)
		// else
		// 	return split_date[0] + '.' + split_date[1].substring(2)
	};



</script>

{% endblock %}


