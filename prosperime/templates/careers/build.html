{% extends "base_full.html" %}

{% block head %}

<!-- CSS -->
	<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/build.css" />


<!-- JS -->
	<script type="text/javascript" src="{{ STATIC_URL }}js/raphael-min.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}js/backbone.js"></script>
	<script async type="text/javascript" src="{{ STATIC_URL }}js/timeline-viz.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.autocomplete.min.js"></script>

{% endblock %}



{% block content %}

<div id="content-container" class="main-container">

	<div class="build-header">
		Build: 
		{% if title == "Untitled" %}
			<span class="build-header-name italicize"> {{title}} </span>
		{% else %}
			<span class="build-header-name"> {{title}} </span>
		{% endif %}
	</div>

	<div class="call-out-text">
		Build a career path using one of your current positions, or a completely new starting point.
	</div>

	<div id="build-positions-container">
		{% if current_positions %}

			<div class="build-sub-header">
				Current Positions
			</div>

			<div class="flat-button pull-right button-large save-button" onclick="save()">
				Save
			</div>


			<div class="call-out-text smaller">
				Click on a position below to start building.
			</div>

			<table id="build-positions-table" class="table">
			{% for pos in current_positions %}
				<tr><td class="build-start-position" data-id="{{pos.id}}" data-title="{{pos.title}}" data-entity_name="{{pos.entity_name}}">
					{{pos.title}} at {{pos.entity_name}}
				</td></tr>
			{% endfor %}
			</table>

			<div class="build-positions-search">
				<div class="input-append inline">
					<input id="build-positions-search-box" type="text">
					<span id="add-build-position-button" class="add-on"> Add </span>
				</div>
			</div>

		{% else %}
			Search for a job below to find your starting point.
		{% endif %}
	</div>


	<div id="path-container">
		<!-- SVG here -->
	</div>
</div>
{% endblock %}

{% block templates %}




<script type="text/javascript">
	/* Event Handlers */

	$(function() {

		// Hover handler - blue highlight 
		$('#build-positions-table tr').hover(function(ev) {
			$(ev.currentTarget).toggleClass("info")
		}, function(ev) {
			$(ev.currentTarget).toggleClass("info")
		});

		// Current position click handler
		$('#build-positions-table td').click(function(ev) {

			// If already selected, do nothing
			if ($(ev.currentTarget).parent().hasClass("selected")) {
				return false;
			};

			// Clear search box
			$('#build-positions-search-box').val("")

			var id = $(ev.currentTarget).data("id")
			var title = $(ev.currentTarget).data("title")
			var entity_name = $(ev.currentTarget).data("entity_name")

			normalize_rows()

			// For selected row, take off hover handler
			$(ev.currentTarget).parent().off("mouseenter mouseleave").toggleClass("info").addClass("selected")

			// Add this as the first position in path
			add_first_position(id, title, entity_name)
		});

		var position_selected_id = null
		var position_selected_title = null
		var position_selected_entity_name = null
		// Autocomplete for current position
		$('#build-positions-search-box').autocomplete({
	    	serviceUrl: '/careers/positionAutocomplete/',
	    	minChars: 2,
	    	onSelect: function(suggestion) {
				position_selected_id = suggestion.data
				position_selected_title = suggestion.title
				position_selected_entity_name = suggestion.entity_name
		    }
	    });

		// Add click handler to search box
	    $('#add-build-position-button').click(function(ev) {

	    	// If there's something there
	    	if ($('#build-positions-search-box').val().length > 0) {
	    		add_first_position(position_selected_id, position_selected_title, position_selected_entity_name)
	    		normalize_rows()
	    	} 
	    });


		// Title change handlers....
		var enterPressed = function(ev) {
			if (ev.which == 13 && $('.build-input').length > 0) {
				$('.build-header-name').html($('.build-input').val()).removeClass("italicize").click(title_change_handler)
				$(document).off("keypress")
			}
		};

		var title_change_handler = function(ev) {
			var current_text = $('.build-header-name').html()
			var new_html = "<input class='build-input' type='text' placeholder='" + current_text + "' name='path-title-input'>"
			$('.build-header-name').html(new_html).off("click")
			$(document).keypress(enterPressed)
		};

		$('.build-header-name').click(title_change_handler)

		/* Eventually, allow user to click off and save */
			// $(document).click(function(ev) {
			// 	if ($(ev.currentTarget) != $(this)) {
			// 		alert("clicked off this")
			// 	} else {
			// 		alert("clicked this")
			// 	}
			// })
		

	
		/* Raphael Extension giving ID's to sets */
		Raphael.st.setID = function(id) {
			this.id = id;
		};

		Raphael.st.setData = function(name, value) {
			this.data[name] = value
		};

		Raphael.st.unbindAll = function() {
			while(this.events.length) {
				var e = this.events.pop()
				e.unbind()
			}
		};


	});



</script>

<script type="text/javascript">
	/* SVG for Path */

	/* Constants & Instance Variables */
	var options = {{options|safe}}
	var current_pos = {{current_positions|safe}}
	console.log(current_pos)
	var options_data = []
	var chosen_data = []
	var line_data = []

	var paper_w = 1000
	var paper_h = 250
	var midline = 125
	var dot_radius = 12
	var y_range = 200
	var y_max = y_range / 2
	var y_offset = Math.ceil(y_range/(options.length - 1))
	var x_start = 150
	var dot_distance = 200
	var text_offset1 = 40
	var text_offset2 = 25
	var text_offset3 = 10
	var option_text_offset = 50
	var current_rect_id = -1

	/* Attributes */
	var chosen_dot_attributes = {
		'fill':'rgb(41,98,152)',
		'stroke-width':0
	};

	var option_dot_attributes = {
		'fill':'#679FD2',
		'stroke-width':0,
	};

	var chosen_line_attributes = {
		'stroke':'#777'
	};

	var option_line_attributes = {
		'stroke-dasharray':'-',
	};

	var text_attributes = {
		"font-size":12,
	};

	var option_text_attributes = {
		"font-size":12,
		"text-anchor":"start",
	};

	/* Create Paper */
	var paper = new Raphael("path-container", paper_w, paper_h)


	var add_first_position = function(id, title, entity_name) {

		// Check if this is being added or already in current pos
		var match = false
		for (var s = 0; s < current_pos.length; s++)
			if (current_pos[s]['id'] == id) match = true

		if (!match) add_position_to_current_table(id, title, entity_name)

		// Check if path already exists, in which case delete	
		if (chosen_data.length > 0) {
			clear_path()
		}

		/* Create SVG Elements */
		var dot = paper.circle(x_start, midline, dot_radius).attr(chosen_dot_attributes)
		var title_text = paper.text(x_start, midline - text_offset1, title).attr(text_attributes)
		var entity_text = paper.text(x_start, midline - text_offset2, entity_name).attr(text_attributes)

		/* Set relevant data on dot element */
		dot.data("pos_id",id)
		dot.data("title_text_id", title_text.id)
		dot.data("entity_text_id", entity_text.id)

		/* Add 'back' to do */
		dot.click(go_back)

		/* Update data structure */
		chosen_data.push({"dot_id":dot.id, "pos_id":id})

		/* Get and render options */
		render_options(id)
	};

	var render_options = function(id) {

		// TODO Post request to get options //

		// Render options
		for (var i = 0; i < options.length; i++) {

			/* Set X,Y values for animation */
			var x_1 = x_start + (dot_distance * (chosen_data.length - 1))
			var y_1 = midline
			var x_2 = x_start + (dot_distance * chosen_data.length)
			var y_2 = midline + y_max - (y_offset * i)
			
			/* Create SVG Elements */
			var option_dot = paper.circle(x_1, y_1, dot_radius).attr(option_dot_attributes)
			var option_title = paper.text(x_1, y_1, options[i].title).attr(option_text_attributes)
			var option_entity_name = paper.text(x_1, y_1, options[i].entity_name).attr(option_text_attributes)

			/* Animate SVG Elements */
			option_dot.animate({"cx":x_2, "cy":y_2}, "2e2")
			option_title.animate({"x":(x_2 + option_text_offset), "y":y_2 - text_offset3}, "2e2")
			option_entity_name.animate({"x":(x_2 + option_text_offset), "y":(y_2 + text_offset3)}, "2e2")

			/* Gather information needed for hover */
			option_dot.data("title_text_id", option_title.id)
			option_dot.data("entity_text_id", option_entity_name.id)
			option_dot.data("pos_id", id)

			// Update data structure
			options_data.push({'dot_id':option_dot.id, 'position_id':options[i].id, 'title_text_id': option_title.id, 'entity_text_id': option_entity_name.id})

			/* Add hover handlers */
			option_dot.hover(function() {
				this.attr("r", 14)
				paper.getById(this.data("title_text_id")).attr("font-weight","bold").attr("font-size","12")
				paper.getById(this.data("entity_text_id")).attr("font-size","12").attr("font-weight","bold")

			}, function() {
				this.attr("r",dot_radius)
				paper.getById(this.data("title_text_id")).attr("font-weight","normal").attr("font-size", "12")
				paper.getById(this.data("entity_text_id")).attr("font-weight","normal").attr("font-size", "12")
			});

			/* Add Click handler */
			option_dot.click(function() {
				option_clicked(this)
			})
		}
	
	};

	var save = function() {
		console.log("Save")
		var title = $('.build-header-name').html()
		var position_ids = []
		for (var g = 0; g < chosen_data.length; g++) {
			position_ids.push(chosen_data[g]["pos_id"])
		}

		// TODO : Post // 

	};

	var option_clicked = function(el) {
		// Move selected elements && change styling
		el.animate({'cy':midline, 'fill':'rgb(41,98,152)'}, '2e2')
		var id = el.id

		var title_text = paper.getById(el.data("title_text_id"))
		title_text.attr("text-anchor", "middle").attr("font-weight", "normal")
		title_text.animate({"x":x_start + (dot_distance * chosen_data.length), "y": midline - text_offset1}, '2e2')

		var entity_text = paper.getById(el.data("entity_text_id"))
		entity_text.attr("text-anchor", "middle").attr("font-weight", "normal")
		entity_text.animate({"x":x_start + (dot_distance * chosen_data.length), "y": midline - text_offset2}, '2e2')


		// Unbind Events
		while(el.events.length) {
			var e = el.events.pop()
			e.unbind()
		}

		// Because most recent, bind "go back" event
		el.click(go_back)		

		// Remove clicks from previous dots
		if (chosen_data.length > 0) {
			for (var l = 0; l < chosen_data.length; l++) {
				paper.getById(chosen_data[l]["dot_id"]).unclick(go_back)
			}
		}
	
		// Draw line to previous
		var line = paper.path("M" + (x_start + ((chosen_data.length - 1) * dot_distance) + dot_radius) + ', ' + midline + ' L' + (x_start + (chosen_data.length * dot_distance) - dot_radius) + ','  + midline).attr(chosen_line_attributes)

		// Remove other dots
		for (var j = 0; j < options_data.length; j++) {
			if (options_data[j]["dot_id"] != id) {
				paper.getById(options_data[j]["dot_id"]).remove()
				paper.getById(options_data[j]["title_text_id"]).remove()
				paper.getById(options_data[j]["entity_text_id"]).remove()
			}
		}

		// Update DST
		chosen_data.push({"dot_id":el.id, "pos_id":el.data("pos_id")})
		options_data.length = 0
		line_data.push(line.id)
		render_options(el.data("pos_id"))
	}

	var normalize_rows = function() {
		// Color all rows white
		$('#build-positions-table tr').each(function() {
			
			// If it was already selected, unselect and re-add hover //		handler
			if ($(this).hasClass("selected")) {
				$(this).removeClass("selected").hover(function(ev) {
					$(ev.currentTarget).toggleClass("info")
				}, function(ev) {
					$(ev.currentTarget).toggleClass("info")
				});
			}
		})
	};

	var clear_path = function() {
		// Delete dots, options for most recent dot
		remove_chosen_dots()
		remove_options()

		// Delete lines
		for (var d = 0; d < line_data.length; d++) {
			paper.getById(line_data[d]).remove()
		}

		// Clear all data structures
		line_data.length = 0
	}

	var go_back = function() {
		/* Delete most recent dot */
		var most_recent = paper.getById(chosen_data.pop()["dot_id"])
		remove_dot_and_text(most_recent)
		
		/* Remove its options */
		remove_options()

		/* Remove its line */
		if (line_data.length > 0)
			paper.getById(line_data.pop()).remove()

		/* Re-render off of previous dot, if there is one */
		if (chosen_data.length > 0) {
			render_options(chosen_data[chosen_data.length - 1]["pos_id"])
			
			// And re-add click handler
			paper.getById(chosen_data[chosen_data.length - 1]["dot_id"]).click(go_back)
		}

	}

	var remove_dot_and_text = function(dot) {
		paper.getById(dot.data("title_text_id")).remove()
		paper.getById(dot.data("entity_text_id")).remove()
		dot.remove()
	}

	var remove_chosen_dots = function() {

		for (var k = 0; k < chosen_data.length; k++) {
			var dot = paper.getById(chosen_data[k]["dot_id"])
			remove_dot_and_text(dot)
		}
		chosen_data.length = 0;
	};

	var remove_options = function() {
		// Delete option dots, titles, entity names
		for (var j = 0; j < options_data.length; j++) {
			paper.getById(options_data[j]["dot_id"]).remove()
			paper.getById(options_data[j]["title_text_id"]).remove()
			paper.getById(options_data[j]["entity_text_id"]).remove()
		}
		options_data.length = 0
	}

	var add_position_to_current_table = function(id, title, entity_name) {
		console.log('add to table')
		normalize_rows();

		var new_html = "<tr class='selected'><td class='build-start-position' data-id='"+ id + "' data-title='" + title + "' data-entity_name='" + entity_name + "' >" + title + " at " + entity_name + " </td></tr>"
		$('#build-positions-table > tbody:last').append(new_html)
	};

</script>

{% endblock %}